# 方案二：迁移历史修复 — 一步步操作

## 目标
把已应用过的迁移 001～025 标记为「已应用」，这样再执行 `db push` 时只会执行 026，不会从 001 重跑导致「策略已存在」报错。

---

## 第一步：确认已 link 且已登录

在项目根目录（`e:\my-logistics-site`）打开终端，执行：

```powershell
npx supabase migration list
```

- **若提示** `Cannot find project ref` 或 `Have you run supabase link?`  
  → 先执行：`npx supabase link --project-ref 你的项目ReferenceID`（Reference ID 在 Supabase Dashboard → Project Settings → General）
- **若提示** `Access token not provided`  
  → 先执行：`npx supabase login`，按回车在浏览器里登录

---

## 第二步：看迁移列表里的版本格式

同一条命令：

```powershell
npx supabase migration list
```

看输出里的 **REMOTE** 列（或 LOCAL 列）的版本号长什么样：

- 若是 **数字+下划线+名字**（例如 `001_initial_tables`）  
  → 用下面「第三步 A：脚本批量 repair」即可。
- 若是 **纯数字时间戳**（例如 `20230103054303`）  
  → 不能用脚本里的名字，需要按「第三步 B」用时间戳逐个 repair，或先在 Dashboard 用 SQL 插入历史（见文末备选）。

---

## 第三步 A：用脚本批量 repair（版本为 001_xxx 时）

在项目根目录执行：

```powershell
.\scripts\repair-migrations.ps1
```

若某一条报错 **version 不存在**，记下报错里的版本格式，然后改用「第三步 B」按你本地 `migration list` 里显示的版本号手动 repair。

脚本全部成功后，进入**第四步**。

---

## 第三步 B：手动逐条 repair（版本为时间戳或脚本失败时）

先再跑一次看版本号：

```powershell
npx supabase migration list
```

然后对 **001～025** 每一条执行（把 `版本号` 换成 REMOTE/LOCAL 里实际显示的）：

```powershell
npx supabase migration repair 版本号 --status applied
```

例如若显示是 `001_initial_tables`：

```powershell
npx supabase migration repair 001_initial_tables --status applied
npx supabase migration repair 002_shipping_rates --status applied
# ... 一直到 025_storage_product_images_policy_fix
```

若显示是时间戳，则用时间戳：

```powershell
npx supabase migration repair 20240101000000 --status applied
# ... 依此类推
```

共 25 条（001～025），**不要**对 026 做 repair。全部成功后进入**第四步**。

---

## 第四步：再次执行 db push

在项目根目录执行：

```powershell
npx supabase db push
```

此时应**只会应用 026_auction_products_authenticated_select.sql**，不再从 001 重跑。看到 `Finished supabase db push` 即表示成功。

---

## 若 repair 一直报「version 不存在」

说明远程记录迁移的版本格式和本地文件名不一致，可以：

1. **只修「商品不存在」**：在 Supabase Dashboard → SQL Editor 执行 026 的 SQL（见项目根目录或之前对话里的 SQL），不依赖 repair。
2. **坚持修迁移历史**：在 Dashboard → SQL Editor 里查一下当前已应用的版本：
   ```sql
   SELECT * FROM supabase_migrations.schema_migrations ORDER BY version;
   ```
   看 `version` 列格式，再用该格式对 001～025 做 `migration repair`。

---

## 总结顺序

1. `npx supabase login`（若未登录）  
2. `npx supabase link --project-ref xxx`（若未 link）  
3. `npx supabase migration list`（确认版本格式）  
4. 执行 `.\scripts\repair-migrations.ps1` 或手动 repair 001～025  
5. `npx supabase db push`（只应用 026）
